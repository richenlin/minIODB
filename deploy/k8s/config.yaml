apiVersion: v1
kind: ConfigMap
metadata:
  name: miniodb-full-config
  namespace: miniodb-system
  labels:
    app.kubernetes.io/name: miniodb
    app.kubernetes.io/component: config
    app.kubernetes.io/part-of: miniodb-system
data:
  config.yaml: |
    server:
      grpc_port: ":8080"
      rest_port: ":8081"
      node_id: "miniodb-k8s-node"
      
    # 网络和连接池配置
    network:
      server:
        grpc:
          max_connections: 1000
          connection_timeout: 30s
          stream_timeout: 60s
          keep_alive_time: 30s
          keep_alive_timeout: 5s
          max_connection_idle: 15m
          max_connection_age: 30m
          max_connection_age_grace: 5s
          max_send_msg_size: 4194304
          max_recv_msg_size: 4194304
        rest:
          read_timeout: 30s
          write_timeout: 30s
          idle_timeout: 60s
          read_header_timeout: 10s
          max_header_bytes: 1048576
          shutdown_timeout: 30s
      
      pools:
        redis:
          mode: "standalone"
          addr: "redis-service:6379"
          password: "redis123"
          db: 0
          pool_size: 250
          min_idle_conns: 25
          max_conn_age: 1800s
          pool_timeout: 3s
          idle_timeout: 300s
          idle_check_freq: 60s
          dial_timeout: 3s
          read_timeout: 2s
          write_timeout: 2s
          max_retries: 3
          min_retry_backoff: 8ms
          max_retry_backoff: 512ms
          max_redirects: 8
          read_only: false
          route_by_latency: true
          route_randomly: false
        
        minio:
          endpoint: "minio-service:9000"
          access_key_id: "minioadmin"
          secret_access_key: "minioadmin123"
          use_ssl: false
          region: "us-east-1"
          bucket: "miniodb-data"
          max_idle_conns: 300
          max_idle_conns_per_host: 150
          max_conns_per_host: 300
          idle_conn_timeout: 90s
          dial_timeout: 5s
          tls_handshake_timeout: 5s
          response_header_timeout: 15s
          expect_continue_timeout: 1s
          max_retries: 3
          retry_delay: 100ms
          request_timeout: 60s
          keep_alive: 30s
          disable_keep_alive: false
          disable_compression: false
        
        backup_minio:
          endpoint: "minio-backup-service:9000"
          access_key_id: "minioadmin"
          secret_access_key: "minioadmin123"
          use_ssl: false
          region: "us-east-1"
          bucket: "miniodb-backup"
          max_idle_conns: 100
          max_idle_conns_per_host: 50
          max_conns_per_host: 100
          idle_conn_timeout: 90s
          dial_timeout: 10s
          tls_handshake_timeout: 10s
          response_header_timeout: 30s
          expect_continue_timeout: 1s
          max_retries: 3
          retry_delay: 100ms
          request_timeout: 120s
          keep_alive: 30s
          disable_keep_alive: false
          disable_compression: false
        
        health_check_interval: 15s

    # Redis配置（保持向后兼容）
    redis:
      enabled: true
      mode: "standalone"
      addr: "redis-service:6379"
      password: "redis123"
      db: 0
      pool_size: 100
      min_idle_conns: 10
      dial_timeout: 5s
      read_timeout: 3s
      write_timeout: 3s

    # MinIO配置（保持向后兼容）
    minio:
      endpoint: "minio-service:9000"
      access_key_id: "minioadmin"
      secret_access_key: "minioadmin123"
      use_ssl: false
      region: "us-east-1"
      bucket: "miniodb-data"

    # 智能限流系统
    rate_limiting:
      enabled: true
      tiers:
        health:
          requests_per_second: 200
          burst_size: 50
          window_size: "1s"
        query:
          requests_per_second: 100
          burst_size: 30
          window_size: "1s"
        write:
          requests_per_second: 80
          burst_size: 20
          window_size: "1s"
        standard:
          requests_per_second: 50
          burst_size: 15
          window_size: "1s"
        strict:
          requests_per_second: 20
          burst_size: 5
          window_size: "1s"
      path_rules:
        - path: "/health"
          method: "GET"
          tier: "health"
        - path: "/v1/health"
          method: "GET"
          tier: "health"
        - path: "/metrics"
          method: "GET"
          tier: "health"
        - path: "/v1/query"
          method: "POST"
          tier: "query"
        - path: "/v1/write"
          method: "POST"
          tier: "write"
        - path: "/v1/backup/trigger"
          method: "POST"
          tier: "strict"
        - path: "/v1/recover"
          method: "POST"
          tier: "strict"
      default_tier: "standard"
      response:
        include_tier: true
        include_limit: true
        include_burst: true
        include_window: true
        include_retry_after: true

    # 查询性能优化
    query_optimization:
      query_cache:
        enabled: true
        redis_key_prefix: "qcache:"
        default_ttl: 3600s
        max_cache_size: 209715200
        eviction_policy: "lru"
        cache_strategies:
          simple_select: 7200s
          count_query: 3600s
          aggregation: 1800s
          join_query: 900s
          complex_query: 600s
        table_invalidation:
          enabled: true
          invalidation_delay: 5s
        enable_stats: true
        stats_interval: 60s
      
      file_cache:
        enabled: true
        cache_dir: "/tmp/miniodb_cache"
        max_cache_size: 1073741824
        max_file_age: 14400s
        cleanup_interval: 900s
        redis_index:
          enabled: true
          key_prefix: "fcache:"
          index_ttl: 86400s
        metadata:
          track_access_count: true
          track_creation_time: true
          enable_hash_verification: true
        enable_stats: true
        stats_interval: 60s
      
      duckdb:
        enabled: true
        pool_size: 5
        max_idle_time: 1800s
        connection_timeout: 30s
        performance:
          memory_limit: "1GB"
          threads: 4
          enable_object_cache: true
          temp_directory: "/tmp/duckdb"
        prepared_statements:
          enabled: true
          cache_size: 100
          auto_prepare_aggregations: true
        connection_reuse:
          enabled: true
          max_reuse_count: 1000
          health_check_interval: 300s

    # 存储引擎优化配置
    storage_engine:
      enabled: true
      auto_optimization: true
      optimize_interval: 1800s
      performance_mode: "balanced"
      enable_monitoring: true
      enable_profiling: false
      parquet:
        default_compression: "zstd"
        default_partition: "analytical"
        auto_select_strategy: true
        compression_analysis: true
        metadata_indexing: true
        custom_strategies:
          analytics_workload: "compression_optimized"
          streaming_workload: "streaming"
          mixed_workload: "analytical"
      sharding:
        default_strategy: "hash_uniform"
        auto_rebalance: true
        hot_cold_separation: true
        locality_optimization: true
        rebalance_threshold: 0.8
        migration_limit: 3
      indexing:
        auto_index_creation: true
        index_types: ["bloom", "minmax", "inverted", "bitmap", "composite"]
        bloom_filter_enabled: true
        minmax_enabled: true
        inverted_enabled: true
        composite_enabled: true
        maintenance_interval: 3600s
        custom_config:
          bloom_filter_fpp: 0.01
          inverted_min_term_length: 2
          bitmap_cardinality_threshold: 1000
      memory:
        enable_pooling: true
        enable_zero_copy: true
        buffer_optimization: true
        gc_optimization: true
        max_memory_usage: 2147483648
        memory_pool_sizes:
          small: 1024
          medium: 16384
          large: 262144
          xlarge: 1048576
        gc_interval: 300s

    # 缓冲区优化配置
    buffer:
      buffer_size: 5000
      flush_interval: 15s
      worker_pool_size: 20
      task_queue_size: 100
      batch_flush_size: 5
      enable_batching: true
      flush_timeout: 60s
      max_retries: 3
      retry_delay: 1s
      enable_concurrent: true
      enable_metrics: true

    # 备份配置
    backup:
      enabled: true
      interval: 3600
      minio:
        endpoint: "minio-backup-service:9000"
        access_key_id: "minioadmin"
        secret_access_key: "minioadmin123"
        use_ssl: false
        bucket: "miniodb-backup"
      metadata:
        enabled: true
        interval: 30m
        retention_days: 7
        bucket: "miniodb-metadata"

    # 日志配置
    log:
      level: "info"
      format: "json"
      output: "both"
      filename: "logs/minIODB.log"
      max_size: 100
      max_backups: 5
      max_age: 30
      compress: true

    # 监控配置
    monitoring:
      enabled: true
      port: ":8082"
      path: "/metrics"
      prometheus: true

    # 认证配置
    auth:
      enable_jwt: true
      jwt_secret: "your-super-secret-jwt-key-change-this-in-production"
      token_expiry: "24h"
      enable_api_key: true
      api_keys:
        - "api-key-1234567890abcdef"
        - "api-key-0987654321fedcba"
      skip_auth_paths:
        - "/health"
        - "/metrics"
        - "/v1/health"
      require_auth_paths:
        - "/v1/write"
        - "/v1/query"
        - "/v1/backup/trigger"
        - "/v1/recover"
      admin_roles:
        - "admin"
        - "superuser"
      user_roles:
        - "user"
        - "api"

    # 表管理配置
    table_management:
      auto_create_tables: true
      default_table: "default"
      max_tables: 1000
      table_name_pattern: "^[a-zA-Z][a-zA-Z0-9_]{0,63}$"
      default_config:
        buffer_size: 1000
        flush_interval: 30s
        retention_days: 365
        backup_enabled: true
        properties: {}
      tables: {}

    # 安全配置（保持向后兼容）
    security:
      mode: "jwt"
      jwt_secret: "your-super-secret-jwt-key-change-this-in-production"
      enable_tls: false
      valid_tokens: 
        - "test-token-123456"
        - "admin-token-abcdef"
      cert_file: "certs/server.crt"
      key_file: "certs/server.key"
      smart_rate_limit:
        enabled: true
        default_tier: "standard"
        cleanup_interval: "5m"
        tiers:
          - name: "health"
            requests_per_sec: 200
            burst_size: 400
            window: "1m"
            backoff_duration: "1s"
          - name: "query"
            requests_per_sec: 100
            burst_size: 200
            window: "1m"
            backoff_duration: "2s"
          - name: "write"
            requests_per_sec: 80
            burst_size: 160
            window: "1m"
            backoff_duration: "3s"
          - name: "standard"
            requests_per_sec: 50
            burst_size: 100
            window: "1m"
            backoff_duration: "3s"
          - name: "strict"
            requests_per_sec: 20
            burst_size: 40
            window: "1m"
            backoff_duration: "10s"
        path_limits:
          - pattern: "/v1/health"
            tier: "health"
            enabled: true
          - pattern: "/health"
            tier: "health"
            enabled: true
          - pattern: "/metrics"
            tier: "health"
            enabled: true
          - pattern: "/v1/query"
            tier: "query"
            enabled: true
          - pattern: "/v1/data"
            tier: "write"
            enabled: true
          - pattern: "/v1/tables"
            tier: "write"
            enabled: true
          - pattern: "/v1/backup"
            tier: "strict"
            enabled: true
      rate_limit:
        enabled: false
        requests_per_minute: 10000

    # 表配置（保持向后兼容）
    tables:
      default_config:
        buffer_size: 5000
        flush_interval: 15s
        retention_days: 365
        backup_enabled: true
        properties: {}
      tables: {}

