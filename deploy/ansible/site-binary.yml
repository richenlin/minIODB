---
# MinIODBäºŒè¿›åˆ¶éƒ¨ç½²ä¸»playbook
# æ”¯æŒç¦»çº¿éƒ¨ç½²å’Œå¤šæ¶æ„é€‚é…

- name: MinIODBäºŒè¿›åˆ¶éƒ¨ç½² - ç³»ç»Ÿé¢„æ£€
  hosts: miniodb_nodes
  gather_facts: true
  become: true
  tags: [prereq, setup]
  
  pre_tasks:
    - name: æ˜¾ç¤ºéƒ¨ç½²ä¿¡æ¯
      debug:
        msg: |
          ğŸš€ å¼€å§‹MinIODBäºŒè¿›åˆ¶éƒ¨ç½²
          
          éƒ¨ç½²æ¨¡å¼: {{ deployment_mode | default('offline') }}
          éƒ¨ç½²ç±»å‹: {{ deployment_type | default('single') }}
          ç›®æ ‡æ¶æ„: {{ ansible_architecture }}
          ä¸»æœºæ•°é‡: {{ ansible_play_hosts | length }}
          
          ç›®æ ‡ä¸»æœº:
          {% for host in ansible_play_hosts %}
          - {{ host }} ({{ hostvars[host]['ansible_default_ipv4']['address'] }})
          {% endfor %}
      run_once: true
      
  roles:
    - role: prereq
      tags: [prereq]

- name: MinIODBäºŒè¿›åˆ¶éƒ¨ç½² - ä¸‹è½½å’Œåˆ†å‘
  hosts: miniodb_nodes
  gather_facts: false
  become: true
  tags: [download, distribution]
  
  tasks:
    - name: æ£€æŸ¥ç¦»çº¿åŒ…æ˜¯å¦å­˜åœ¨
      stat:
        path: "{{ playbook_dir }}/files/{{ system_info.architecture | default(ansible_architecture) }}/bin"
      register: offline_packages
      delegate_to: localhost
      run_once: true
      
    - name: ç¦»çº¿åŒ…æ£€æŸ¥ç»“æœ
      fail:
        msg: |
          ç¦»çº¿åŒ…ä¸å­˜åœ¨ï¼è¯·å…ˆè¿è¡Œä¸‹è½½è„šæœ¬:
          cd {{ playbook_dir }}
          ./scripts/download-binaries.sh
      when: not offline_packages.stat.exists
      run_once: true
      
    - name: åˆ†å‘äºŒè¿›åˆ¶æ–‡ä»¶
      copy:
        src: "{{ playbook_dir }}/files/{{ system_info.architecture | default(ansible_architecture) }}/bin/"
        dest: "{{ miniodb.install_dir }}/bin/"
        mode: '0755'
        owner: miniodb
        group: miniodb
      tags: [binaries]
      
    - name: åˆ†å‘é…ç½®æ¨¡æ¿
      copy:
        src: "{{ playbook_dir }}/files/configs/"
        dest: "{{ miniodb.config_dir }}/"
        owner: miniodb
        group: miniodb
      tags: [configs]

- name: MinIODBäºŒè¿›åˆ¶éƒ¨ç½² - RedisæœåŠ¡
  hosts: miniodb_cache
  gather_facts: false
  become: true
  tags: [redis]
  
  tasks:
    - name: æ£€æŸ¥Redisæºç 
      stat:
        path: "{{ miniodb.install_dir }}/redis-source"
      register: redis_source_check
      
    - name: è§£å‹Redisæºç ï¼ˆå¦‚æœéœ€è¦ç¼–è¯‘ï¼‰
      unarchive:
        src: "{{ playbook_dir }}/files/{{ system_info.architecture | default(ansible_architecture) }}/redis/redis-*.tar.gz"
        dest: "{{ miniodb.install_dir }}/"
        owner: miniodb
        group: miniodb
        creates: "{{ miniodb.install_dir }}/redis-source"
      when: not redis_source_check.stat.exists
      
    - name: ç¼–è¯‘Redisï¼ˆå¦‚æœRedisäºŒè¿›åˆ¶ä¸å­˜åœ¨ï¼‰
      shell: |
        cd {{ miniodb.install_dir }}/redis-source
        make -j$(nproc)
        make install PREFIX={{ miniodb.install_dir }}
      args:
        creates: "{{ miniodb.install_dir }}/bin/redis-server"
      become_user: miniodb
      
    - name: åˆ›å»ºRedisé…ç½®æ–‡ä»¶
      template:
        src: "{{ playbook_dir }}/files/configs/redis.conf"
        dest: "/etc/redis/redis.conf"
        owner: redis
        group: redis
        mode: '0640'
      notify: restart redis
      
    - name: åˆ›å»ºRedis systemdæœåŠ¡
      template:
        src: "{{ playbook_dir }}/files/configs/redis.service"
        dest: "/etc/systemd/system/redis.service"
      notify:
        - reload systemd
        - restart redis
        
    - name: å¯åŠ¨RedisæœåŠ¡
      systemd:
        name: redis
        state: started
        enabled: true
        daemon_reload: true

- name: MinIODBäºŒè¿›åˆ¶éƒ¨ç½² - MinIOæœåŠ¡
  hosts: miniodb_storage
  gather_facts: false
  become: true
  tags: [minio]
  
  tasks:
    - name: åˆ›å»ºMinIOç¯å¢ƒé…ç½®
      template:
        src: "{{ playbook_dir }}/files/configs/minio.env"
        dest: "/etc/default/minio"
        owner: minio
        group: minio
        mode: '0640'
      notify: restart minio
      
    - name: åˆ›å»ºMinIO systemdæœåŠ¡
      template:
        src: "{{ playbook_dir }}/files/configs/minio.service" 
        dest: "/etc/systemd/system/minio.service"
      notify:
        - reload systemd
        - restart minio
        
    - name: å¯åŠ¨MinIOæœåŠ¡
      systemd:
        name: minio
        state: started
        enabled: true
        daemon_reload: true
        
    # å¤‡ä»½MinIOé…ç½®ï¼ˆå¦‚æœå¯ç”¨ï¼‰
    - name: åˆ›å»ºå¤‡ä»½MinIOç¯å¢ƒé…ç½®
      template:
        src: "{{ playbook_dir }}/templates/minio-backup.env.j2"
        dest: "/etc/default/minio-backup"
        owner: minio
        group: minio
        mode: '0640'
      when: minio.backup_enabled | default(true)
      notify: restart minio-backup
      
    - name: åˆ›å»ºå¤‡ä»½MinIO systemdæœåŠ¡
      template:
        src: "{{ playbook_dir }}/templates/minio-backup.service.j2"
        dest: "/etc/systemd/system/minio-backup.service"
      when: minio.backup_enabled | default(true)
      notify:
        - reload systemd
        - restart minio-backup
        
    - name: å¯åŠ¨å¤‡ä»½MinIOæœåŠ¡
      systemd:
        name: minio-backup
        state: started
        enabled: true
        daemon_reload: true
      when: minio.backup_enabled | default(true)

- name: MinIODBäºŒè¿›åˆ¶éƒ¨ç½² - å­˜å‚¨æ¡¶åˆå§‹åŒ–
  hosts: miniodb_storage[0]  # åªåœ¨ç¬¬ä¸€ä¸ªå­˜å‚¨èŠ‚ç‚¹æ‰§è¡Œ
  gather_facts: false
  become: true
  tags: [init-storage, buckets]
  
  roles:
    - role: init-storage
      tags: [init-storage]

- name: MinIODBäºŒè¿›åˆ¶éƒ¨ç½² - MinIODBåº”ç”¨
  hosts: miniodb_compute
  gather_facts: false
  become: true
  tags: [miniodb-app]
  
  tasks:
    - name: åˆ›å»ºMinIODBé…ç½®æ–‡ä»¶
      template:
        src: "{{ playbook_dir }}/templates/miniodb-config.yaml.j2"
        dest: "{{ miniodb.config_dir }}/config.yaml"
        owner: miniodb
        group: miniodb
        mode: '0644'
      notify: restart miniodb
      
    - name: åˆ›å»ºMinIODB systemdæœåŠ¡
      template:
        src: "{{ playbook_dir }}/files/configs/miniodb.service"
        dest: "/etc/systemd/system/miniodb.service"
      notify:
        - reload systemd
        - restart miniodb
        
    - name: å¯åŠ¨MinIODBæœåŠ¡
      systemd:
        name: miniodb
        state: started
        enabled: true
        daemon_reload: true

- name: MinIODBäºŒè¿›åˆ¶éƒ¨ç½² - éªŒè¯å’Œå¥åº·æ£€æŸ¥
  hosts: miniodb_nodes
  gather_facts: false
  become: false
  tags: [verification, health-check]
  
  tasks:
    - name: ç­‰å¾…æœåŠ¡å¯åŠ¨
      wait_for:
        port: "{{ item }}"
        host: "{{ ansible_default_ipv4.address }}"
        timeout: 60
      loop:
        - "{{ redis.port }}"
        - "{{ minio.api_port }}"
        - "{{ miniodb_app.rest_port }}"
        - "{{ miniodb_app.grpc_port }}"
      
    - name: å¥åº·æ£€æŸ¥ - Redis
      uri:
        url: "redis://{{ ansible_default_ipv4.address }}:{{ redis.port }}"
        method: GET
        timeout: 10
      ignore_errors: true
      register: redis_health
      
    - name: å¥åº·æ£€æŸ¥ - MinIO
      uri:
        url: "http://{{ ansible_default_ipv4.address }}:{{ minio.api_port }}/minio/health/live"
        method: GET
        timeout: 10
      register: minio_health
      
    - name: å¥åº·æ£€æŸ¥ - MinIODB REST API
      uri:
        url: "http://{{ ansible_default_ipv4.address }}:{{ miniodb_app.rest_port }}/v1/health"
        method: GET
        timeout: 10
      register: miniodb_health
      
    - name: æ˜¾ç¤ºéƒ¨ç½²ç»“æœ
      debug:
        msg: |
          ğŸ‰ MinIODBäºŒè¿›åˆ¶éƒ¨ç½²å®Œæˆï¼
          
          æœåŠ¡çŠ¶æ€:
          - Redis: {{ redis_health.status | default('ERROR') == 200 | ternary('âœ… æ­£å¸¸', 'âŒ å¼‚å¸¸') }}
          - MinIO: {{ minio_health.status | default('ERROR') == 200 | ternary('âœ… æ­£å¸¸', 'âŒ å¼‚å¸¸') }}
          - MinIODB: {{ miniodb_health.status | default('ERROR') == 200 | ternary('âœ… æ­£å¸¸', 'âŒ å¼‚å¸¸') }}
          
          è®¿é—®åœ°å€:
          - MinIODB REST API: http://{{ ansible_default_ipv4.address }}:{{ miniodb_app.rest_port }}
          - MinIODB gRPC: {{ ansible_default_ipv4.address }}:{{ miniodb_app.grpc_port }}
          - MinIO Console: http://{{ ansible_default_ipv4.address }}:{{ minio.console_port }}
          - Metrics: http://{{ ansible_default_ipv4.address }}:{{ miniodb_app.metrics_port }}/metrics
          
          å­˜å‚¨æ¡¶:
          {% if storage_init_results is defined %}
          - ä¸»å­˜å‚¨æ¡¶: {{ storage_init_results.primary_bucket_created | ternary('âœ…', 'âŒ') }} {{ minio.primary_bucket }}
          - å…ƒæ•°æ®å­˜å‚¨æ¡¶: {{ storage_init_results.metadata_bucket_created | ternary('âœ…', 'âŒ') }} {{ minio.metadata_bucket }}
          {% if minio.backup_enabled %}
          - å¤‡ä»½å­˜å‚¨æ¡¶: {{ storage_init_results.backup_bucket_created | ternary('âœ…', 'âŒ') }} {{ minio.backup_bucket }}
          {% endif %}
          {% endif %}
          
          ğŸš€ éƒ¨ç½²æˆåŠŸå®Œæˆï¼
      run_once: true

  handlers:
    - name: reload systemd
      systemd:
        daemon_reload: true
        
    - name: restart redis
      systemd:
        name: redis
        state: restarted
        
    - name: restart minio
      systemd:
        name: minio
        state: restarted
        
    - name: restart minio-backup
      systemd:
        name: minio-backup
        state: restarted
      when: minio.backup_enabled | default(true)
        
    - name: restart miniodb
      systemd:
        name: miniodb
        state: restarted 